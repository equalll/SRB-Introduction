# SRB总线协议V1.0
`lee8871@126.com`
## 概述
### 什么是SRB
Simple Robot Bus 简单机器人总线。</br>
SRB是一种总线协议，基于485总线，速度采用2Mb/s，使用9bit模式传输信息，总线采用一主多从结构，可以支持32个物理节点，或128个逻辑节点。
### 总线网络分层
SRB分为以下四层
1. 物理层（PHY）：关于总线的收发硬件，硬件可以使用多种方案，包括使用CAN总线驱动器。
1. 介质访问控制层（MAC）：控制节点访问总线的时机，进行包的收发，防止总线冲突。
1. 总线逻辑控制层（BLC）：根据收到包的类型进行进行数据收发，数据的收发通过缓冲区与应用层进行数据交互。这一层又分为多个部分：
  1. 数据通信（data0~data3）
  2. 簇信息通信（clu）
  3. 事件-命令通信（cmd）
  4. 重发命令（rpt）
1. 应用层（APL）：应用层进行周期性的任务，在任务完成后对缓冲区进行读写操作。
![](http://on-img.com/chart_image/5bc9c407e4b06fc64b24cf6f.png)

## 物理层
本协议使用485总线。</br>
1bit起始位，1bit停止位，无奇偶校验，9bit数据位。bit8=1表示bit0-7位为地址，bit8=0表示bit0-7位为数据。
## 数据链路层
本协议采用Modbus协议。主机发送一个数据包到节点，然后节点立即返回一个数据包，以完成一次访问。
### 下行包
下行包为主机发往节点的包，内容如下:
项目 | 长度 |意义
----|----|-----
**Addr** | 1 | 目的地址其bit9为1，其余数据的第九位为0
**Bfc.port** | 3/8 | 目的节点的某个端口号
**Bfc.length** |  5/8 | 包的数据负载Data部分的长度。
**Data** | Bfc.length | 数据负载
**Crc8** | 1 | 整个包的校验字，包含Addr
下行包的长度可以为0，表示主机没有想要发给节点的数据，但期待节点回复一些数据。
### 上行包
上行包紧跟着下行包进行传输，当节点收到完整的下行包后，立即发送一个上行包。
上行包的内容如下：
项目 | 长度 |意义
----  | ----  | -----
**Bfc.error**| 1/8 | 此次收到的包含错误时为1，否则为0。
**Bfc.busy**|1/8|如果节点收到了数据，但是没有空间储存数据，则返回1, 否则返回0。
**Bfc.event**|1/8|节点的事件队列中有信息时为1，否则为0。
**Bfc.length**|5/8| 包的数据负载Data部分的长度。
**Data**|Bfc.length| 数据负载。
**Crc8**|1| 整个包的校验字。
节点在收到下行包后，如果下行包Crc校验通过，节点立即返回一个上行包。如果没有需要发送的数据，节点返回一个空的上行包，没有Data部分，用于通知主机节点已经正确接收到了数据。
### 异常处理
如果Crc校验错误或接受超时，节点不做任何动作，并等待下一个Addr。
主机接收节点信息时发生校验错误或接收超时，则主机发送一个重发命令包，让节点返回之前发送的数据。
如果Crc正确，则将此数据交付往总线逻辑控制层。
## 总线逻辑控制层
总线逻辑控制层根据收到数据的端口（Bfc.port）选择数据的处理方式。
### 4.1.1.	端口说明
```0~3:	D0 D1 D2 D3 数据交互端口，上位机发给节点一组数据，节点返回一组数据，数据的长度和意义都是固定的。每个节点有多个数据交互端口，每个端口定义的上行，下行数据不同，但可以相同。可以使用配置初始化参数配置数据交互端口的上行和下行数据，也可以存在不可配置的端口。```
```4:	CE 命令事件交互端口，每个节点有一个事件交互端口，发往此端口的数据被理解为命令，每条命令占用8bit，根据命令的类型，其后可跟随数据。节点随后返回事件。命令为一些不常用的事件，比如急停，重启，开门等，相比于数据端口，在没有任务时，命令可以不交互，以便减小传输开支。事件为节点处发生的不常见的情况，如电机过载，撞到墙壁，探针探测到物体，收到数据。```
```5:	CFG配置初始化参数，用于配置节点的初始化参数，包括节点地址，数据交互端口的数据长度和意义，也包括对节点功能的配置，例如电机对码盘的传动比，最大电流等。配置参数端口的第一个数据表示地址，如果没有后续数据，则节点返回当前配置的数据。```
```6: 	   FLW流通信端口，此端口用于实现用于调试的流通信端口，上行和下行的数据都是流通信的信息```
```7:	   RES保留功能端口，此端口用于访问保留的端口，后续第一个数据为端口地址。```
